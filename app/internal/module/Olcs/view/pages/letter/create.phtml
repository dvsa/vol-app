<form method="post" id="letter-create-form" data-generate-url="/letter/generate?<?= http_build_query($queryParams) ?>">
<input type="hidden" name="letterType" value="<?= $this->escapeHtmlAttr($templateId) ?>">
<h2 class="govuk-heading-m">Select content options</h2>
<p class="govuk-body">Use the checkboxes in the sections below to choose what to include in your letter. You can also add attachments.</p>

<div id="validation-error" class="govuk-error-message" style="display: none; margin-bottom: 1rem;">
    <span class="govuk-visually-hidden">Error:</span> Please choose at least one issue
</div>

<p class="govuk-body">
    <a href="#" class="govuk-link" id="toggle-all-sections">Show All Sections</a>
</p>

<div class="letter-sections">
    <?php foreach ($accordionData as $section): ?>
        <?php if (empty($section['issues'])): continue; endif; ?>
        <div class="letter-section">
            <div class="letter-section__header" style="cursor: pointer; border-bottom: 1px solid #b1b4b6; padding: 10px 0;">
                <h3 class="letter-section__title govuk-heading-s" style="display: inline-block; margin: 0;">
                    <?= $this->escapeHtml($section['issueType']['name']) ?>
                </h3>
                <span class="letter-section__toggle govuk-link" style="float: right; font-size: 14px;">
                    <span class="letter-section__show-hide">Show</span>
                    <span class="letter-section__icon" style="display: inline-block; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 4px solid #1d70b8; margin-left: 5px; vertical-align: middle;"></span>
                </span>
            </div>
            <div class="letter-section__content" style="display: none; padding: 15px 0; border-bottom: 1px solid #b1b4b6;">
                <?php if (!empty($section['issues'])): ?>
                    <div class="govuk-checkboxes govuk-checkboxes--small">
                        <?php foreach ($section['issues'] as $issue): ?>
                            <div class="govuk-checkboxes__item">
                                <input
                                    class="govuk-checkboxes__input"
                                    id="letter-issue-<?= $issue['id'] ?>"
                                    name="letterIssues[]"
                                    type="checkbox"
                                    value="<?= $issue['id'] ?>"
                                >
                                <label class="govuk-label govuk-checkboxes__label govuk-label--s" for="letter-issue-<?= $issue['id'] ?>">
                                    <?= $this->escapeHtml($issue['currentVersion']['heading'] ?? $issue['issueKey']) ?>
                                </label>
                            </div>
                        <?php endforeach; ?>
                    </div>
                <?php else: ?>
                    <p class="govuk-body-s">No issues available for this category.</p>
                <?php endif; ?>
            </div>
        </div>
    <?php endforeach; ?>
</div>

<div class="govuk-button-group" style="margin-top: 2rem;">
    <button type="button" id="create-letter-btn" class="govuk-button govuk-button--disabled" data-module="govuk-button" disabled>
        Create letter
    </button>
    <a class="govuk-link" href="#" id="cancel-letter-btn">Cancel</a>
</div>

<div id="placeholder-message" class="govuk-inset-text" style="display: none; margin-top: 1rem;">
    <strong>Preview functionality to be implemented in VOL-5519</strong>
    <p class="govuk-body-s" style="margin-top: 0.5rem;">
        Selected issues: <span id="selected-issues-count">0</span>
    </p>
</div>
</form>

<div id="letter-debug-output" style="display: none; margin-top: 2rem;">
    <div class="govuk-panel govuk-panel--confirmation" style="background-color: #00703c;">
        <h2 class="govuk-panel__title">Letter Instance Created Successfully</h2>
    </div>

    <div style="margin-top: 2rem;">
        <h3 class="govuk-heading-m">Debug Output</h3>
        <details class="govuk-details" data-module="govuk-details" open>
            <summary class="govuk-details__summary">
                <span class="govuk-details__summary-text">View Letter Instance Data</span>
            </summary>
            <div class="govuk-details__text">
                <pre id="debug-content" style="background-color: #f3f2f1; padding: 1rem; overflow-x: auto; font-family: monospace; font-size: 12px; max-height: 500px; overflow-y: auto; border: 1px solid #b1b4b6;"></pre>
            </div>
        </details>
    </div>

    <div class="govuk-inset-text">
        <p class="govuk-body">
            <strong>For Development/Testing:</strong> The letter instance has been created with all selected issues.
            Sections, todos, and appendices will be added in future tickets.
        </p>
        <p class="govuk-body">
            Review the JSON output above to verify the letter instance was created correctly with all relationships.
        </p>
    </div>
</div>
