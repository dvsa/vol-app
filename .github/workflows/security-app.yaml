name: Security
permissions:
  contents: read
  security-events: write

on:
  workflow_call:
  schedule:
    # Weekly on Monday at 00:00 UTC
    - cron: 0 0 * * 1

jobs:
  app-scan:
    name: App - ${{ matrix.project }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [api, internal, selfserve, cdn]
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4
      - name: Setup Snyk
        uses: snyk/actions/setup@master
      - name: Scan ${{ matrix.project }}
        run: snyk test ${{ matrix.project }} --sarif-file-output=${{ matrix.project }}-snyk-results.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Fix SARIF security-severity values
        if: ${{ always() }}
        run: |
          if [ -f "${{ matrix.project }}-snyk-results.sarif" ]; then
            jq '(.runs[].tool.driver.rules // [])[] |= (
              if .properties["security-severity"] == null or .properties["security-severity"] == "undefined" then
                .properties["security-severity"] = "5.0"
              else
                .
              end
            )' "${{ matrix.project }}-snyk-results.sarif" > "${{ matrix.project }}-snyk-results-fixed.sarif"
            mv "${{ matrix.project }}-snyk-results-fixed.sarif" "${{ matrix.project }}-snyk-results.sarif"
          fi
      - name: Upload Results to GitHub Code Scanning
        if: ${{ always() }}
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: app/${{ matrix.project }}-snyk-results.sarif
          category: snyk-${{ matrix.project }}
