name: Security
permissions:
  contents: read
  security-events: write

on:
  workflow_call:
  schedule:
    # Weekly on Monday at 00:00 UTC
    - cron: 0 0 * * 1

jobs:
  app-scan:
    name: App - ${{ matrix.project }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [api, internal, selfserve, cdn]
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4
      - name: Setup Snyk
        uses: snyk/actions/setup@master
      - name: Scan ${{ matrix.project }}
        run: snyk test ${{ matrix.project }} --sarif-file-output=${{ matrix.project }}-snyk-results.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      - name: Upload Results to GitHub Code Scanning
        if: ${{ always() }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: app/${{ matrix.project }}-snyk-results.sarif
          category: snyk-${{ matrix.project }}
